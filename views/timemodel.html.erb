
<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js' type='text/javascript'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js' type='text/javascript'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js' type='text/javascript'></script>
<link rel="stylesheet" href='http://twitter.github.io/bootstrap/assets/css/bootstrap.css'>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>

<!-- <script src='/public/js/script.js'></script> -->

<script type='text/template' id='template-timemodel'>
  Time = <%= time %>
</script>

<div id='timemodel-container'></div>

<div id='button_container'></div>

<div id='edge_container'></div>

<div class="btn-group">
  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
    filter by section
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu">
  <!-- buttons get appended here -->  
 </ul>
</div>

</br>
</br>

<div id='node_button_container'></div>

<script type='text/javascript'>

  var TimemodelApp = {
    Models: {},
    Collections: {},
    Views: {},
    Templates: {}
  };

  TimemodelApp.Models.Timemodel = Backbone.Model.extend({
    defaults: {
    
    },
    initialize: function(){

    }
  });

  TimemodelApp.Models.Node = Backbone.Model.extend({
    defaults: {
    },
    initialize: function(){

    }
  });

  var TimemodelCollection = Backbone.Collection.extend({
    model: TimemodelApp.Models.Timemodel,
    url: "/api/timemodel"
  });

  var NodesCollection = Backbone.Collection.extend({
    initialize: function(models, options){
      this.id = options.id
    },
    model: TimemodelApp.Models.Node,
    url: function(){
      return '/api/timemodel/' + this.id + '/nodes'
    }
  })

  var ConnectedNodesCollection = Backbone.Collection.extend({
    initialize: function(models, options){
      this.id = options.id
      this.node_name = options.node_name
    },
    model: TimemodelApp.Models.Node,
    url: function(){
      return '/api/timemodel/' + this.id + '/node/' + this.node_name
    }
  })

  var TimemodelView1 = Backbone.View.extend({
    el: $('body'),
    events: {
      'click #button_container button': 'buttonClick',
      'click #node_button_container button': 'nodeButtonClick'
    },
    initialize: function(){
      _.bindAll(this, 'render')
      this.render();
    },
    render: function(){

      fetch.done(function(){

        main_collection.forEach(function(model){
          $(this.el).append("This is the time " + model.get('time'));
          $('#button_container').append("<button class='test_button' data-id='" + model.get('_id') + "'>" + model.get('time') + "</button>")
        })

        $('#timemodel-container').html($(this.el).html());
        return this;
      })
    },
    buttonClick: function(e){
      var collectionID = $(e.currentTarget).data("id") // get id of current button

      nodesCollection = new NodesCollection([], {id: collectionID});
      getNodes = nodesCollection.fetch();
   
      getNodes.done(function(){

        nodesCollection.forEach(function(node){
          $(this.el).append("This is the hostname " + node.get('hostname'));
          $('#dropdown-menu').append("<li><a href='#' data-name='"+ node.get('hostname') + "' data-timeid='" + node.get('timemodel_id') + "'>" + node.get('hostname') + "</a></li>")
        })

      })
    },

    nodeButtonClick: function(e){
      console.log("this is the hostname " + $(e.currentTarget).data("name"))
      console.log("this is the id " + $(e.currentTarget).data("timeid"))

      var connectedid = $(e.currentTarget).data("timeid") // get id of current button
      var name = $(e.currentTarget).data("name") //get current hostname

      var connectedNodesCollection = new ConnectedNodesCollection([],{id: connectedid, node_name: name })
      getConnected = connectedNodesCollection.fetch()
      getConnected.done(function(){

        connectedNodesCollection.forEach(function(edge){
          $(this.el).append("From" + edge.get('fromID') + "To" + edge.get('toID'));
          $('#edge_container').append("<h5>From: " + edge.get('fromID') + "    To: " + edge.get('toID') + "</h5>")
        })

      })
    }

  });

  var main_collection = new TimemodelCollection();
  var fetch = main_collection.fetch({update: true, merge: false, remove: false, add: true});
  var nodesCollection

  var timemodelView1 = new TimemodelView1();


</script>